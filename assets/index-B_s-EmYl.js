(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();class _{constructor(t){this.machineCode=t,this.reset()}reset(){this.memory=new Uint8Array(256),this.registers=new Uint8Array(16),this.ip=0,this.terminated=!1}step(){if(this.terminated)return;if(this.ip>=this.machineCode.length)throw new Error("tried to execute instruction that was out of bounds");const t=this.machineCode[this.ip],e=t>>12,i=t>>8&15,r=t>>4&15,n=t&15;let c=0,a=0,d=0;function o(g){g<0&&(a=!0,d=!0),g===0&&(c=!0),g>=256&&(d=!0)}switch(e){case 0:break;case 1:this.terminated=!0;return;case 2:o(this.registers[n]=this.registers[i]+this.registers[r]);break;case 3:o(this.registers[n]=this.registers[i]-this.registers[r]);break;case 4:o(this.registers[n]=this.registers[i]&this.registers[r]);break;case 5:o(this.registers[n]=this.registers[i]|this.registers[r]);break;case 6:o(this.registers[n]=this.registers[i]^this.registers[r]);break;case 7:o(this.registers[r]=~this.registers[i]);break;case 8:o(this.registers[r]=this.registers[i]);break;case 9:o(this.registers[n]=t>>4&255);break;case 10:this.ip=this.registers[i]-1;break;case 11:this.registers[r]!==0&&(this.ip=this.registers[i]-1);break;case 12:o(this.registers[r]=this.memory[this.registers[i]]);break;case 13:this.memory[this.registers[i]]=this.registers[r];break;case 14:o(this.registers[n]=this.registers[i]<<this.registers[r]);break;case 15:o(this.registers[n]=this.registers[i]>>this.registers[r]);break;default:throw new Error("are you okay?")}this.registers[14]=0,this.registers[15]=d<<2|a<<1|c,this.ip++}}function b(s,t,e,i){const r=s.split(`
`);let n=0,c=0,a=-1,d=-1,o=-1;for(const h of r){if(t<n+h.length+1&&a===-1&&(a=c,o=n),e<=n+h.length+1){d=c;break}n+=h.length+1,c++}let g=`Failed to parse code: ${i}.`;for(let h=a;h<=d;h++){const I=r[h],A=o+I.length,B=Math.max(t,o),P=B-o,z=Math.max(Math.min(e,A)-B,1);g+=`
${I}
${" ".repeat(P)}${"^".repeat(z)}`,o+=I.length+1}throw g+=`
At ${a===d?`line ${a+1}`:`lines ${a+1}-${d+1}`}`,new Error(g)}const y="0123456789",L="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",u=Object.freeze({NUMBER:0,IDENTIFIER:1,EOF:2,COLON:3});function j(s){const t=[];let e=0;for(;e<s.length;){const i=s[e];switch(i){case":":t.push({token:u.COLON,start:e,end:e+1});break;case"	":case" ":case`
`:break;case"/":if(s[e+1]==="/"){for(;e<s.length&&s[e]!==`
`;)e++;e--}else if(s[e+1]==="*"){const r=e;for(e+=2;e<s.length&&(s[e]!=="/"||s[e-1]!=="*");)e++;e>=s.length&&b(s,r,r+2,"Expected end of comment")}else b(s,e,e+1,"Expected the start of a comment");break;default:if(y.includes(i)){const r=e;let n="";for(;y.includes(s[e]);)n+=s[e],e++;t.push({token:u.NUMBER,num:Number(n),start:r,end:e}),e--}else if(L.includes(i)){const r=e;let n="";for(;L.includes(s[e])||y.includes(s[e]);)n+=s[e],e++;t.push({token:u.IDENTIFIER,identifier:n,start:r,end:e}),e--}else b(s,e,e+1,"Unknown character");break}e++}return t.push({token:u.EOF,start:e,end:e+1}),t}const S=Object.freeze({__proto__:null,NOP:{opcode:0,args:[]},HALT:{opcode:1,args:[]},ADD:{opcode:2,args:["reg","reg","writereg"]},SUB:{opcode:3,args:["reg","reg","writereg"]},AND:{opcode:4,args:["reg","reg","writereg"]},OR:{opcode:5,args:["reg","reg","writereg"]},XOR:{opcode:6,args:["reg","reg","writereg"]},NOT:{opcode:7,args:["reg","writereg"]},SET:{opcode:8,args:["reg","writereg"]},IST:{opcode:9,args:["num","writereg"]},JMP:{opcode:10,args:["reg"]},JIP:{opcode:11,args:["reg","reg"]},LOD:{opcode:12,args:["reg","writereg"]},STO:{opcode:13,args:["reg","reg"]},SHL:{opcode:14,args:["reg","reg","writereg"]},SHR:{opcode:15,args:["reg","reg","writereg"]}}),N=["r0","r1","r2","r3","r4","r5","r6","r7","r8","r9","r10","r11","r12","r13","zero","status"],G=["status"];class q{constructor(t,e){this.text=e,this.tokens=t,this.idx=0}peek(){return this.tokens[this.idx]}expect(t,e){const i=this.peek();return i.token!==t&&this.errorToken(i,e),this.idx++,i}match(t){const e=this.peek();return e.token!==t?null:(this.idx++,e)}errorToken(t,e){b(this.text,t.start,t.end,e)}parse(){const t=[],e=[],i=new Map;for(;this.peek().token!==u.EOF;){let r=this.expect(u.IDENTIFIER,"Expected an instruction");this.match(u.COLON)&&(i.has(r.identifier)?this.errorToken(r,"Labels must be unique"):i.set(r.identifier,t.length),r=this.expect(u.IDENTIFIER,"Expected an instruction"));const n=S[r.identifier.toUpperCase()];n===void 0&&this.errorToken(r,"Expected a valid instruction");let c=n.opcode,a=0;for(const d of n.args)switch(d){case"writereg":case"reg":{const o=this.expect(u.IDENTIFIER,"Expected a register"),g=N.indexOf(o.identifier);g===-1&&this.errorToken(o,"Expected a valid register"),d==="writereg"&&G.includes(o.identifier)&&this.errorToken(o,`Expected a writable register, and ${o.identifier} is not a writable register`),c=c<<4|g,a++;break}case"num":{const o=this.match(u.IDENTIFIER)??this.expect(u.NUMBER,"Expected a number or label");o.token===u.NUMBER?(o.num>=256&&this.errorToken(o,"Number exceeds 8-bit integer limit"),c=c<<8|o.num):(e.push([t.length,o]),c<<=8),a+=2;break}default:throw new Error("bad code")}for(;a<3;a++)c<<=4;t.push(c)}for(const[r,n]of e){const c=i.get(n.identifier);c===void 0&&this.errorToken(n,"This label does not exist"),t[r]=t[r]&-4081|c<<4}return t.length>=256&&this.errorToken(this.tokens.at(-1),`Too many instructions (there are ${t.length} instructions but the maximum allowed is 256)`),t}}function H(s){const t=new q(j(s),s).parse();return console.log(t),t}const J=document.getElementById("code"),T=document.getElementById("hz"),v=document.getElementById("speed"),K=document.getElementById("compile"),m=document.getElementById("reset"),O=document.getElementById("step"),f=document.getElementById("run"),V=document.getElementById("log"),X=document.getElementById("reg"),Y=document.getElementById("mem"),E=document.getElementById("info"),Q=document.getElementById("size");document.getElementById("dist");const x=[],D=[];let l,p=100,C=!1,F=-1;const W=["ip",...N],Z=new Intl.NumberFormat(void 0,{minimumFractionDigits:0,maximumFractionDigits:2});function $(s){return Z.format(s)}function M(){const s=Math.ceil(p/1e3);for(let t=0;t<s;t++)R(()=>l.step());w(),l.terminated?k():F=setTimeout(M,1e3/p*s)}function k(){C=!1,f.textContent="Run",clearTimeout(F)}function U(s){const t=document.createElement("pre");t.textContent=s,V.append(t),t.scrollIntoView({behavior:"smooth",block:"end"})}function R(s){try{s()}catch(t){U(t.message)}}function w(){for(let s=0;s<256;s++)D[s].textContent=l.memory[s];x[0].textContent=l.ip;for(let s=0;s<16;s++)x[s+1].textContent=l.registers[s];if(l.terminated)U("The program has halted."),E.textContent="No more instructions (the program has halted)";else if(l.ip>=l.machineCode.length)E.textContent="No more instructions (program counter is out of bounds)";else{const s=l.machineCode[l.ip],t=s>>12,e=Object.entries(S).find(i=>i[1].opcode===t);if(e===void 0)E.textContent="Unknown instruction (???)";else{const i=e[1].args.toReversed(),r=[];let c=12-4*i.reduce((a,d)=>a+(d==="num"?2:1),0);for(const a of i){const d=s>>c;if(a==="reg"||a==="writereg"){const o=d&15;r.push(`${N[o]} (${l.registers[o]})`),c+=4}else r.push(d&255),c+=8}E.textContent=`Instruction ${e[0]} ${r.reverse().join(" ")}`}}}K.addEventListener("click",()=>{R(()=>{l=new _(H(J.value)),w(),k(),Q.textContent=l.machineCode.length,m.disabled=!0,O.disabled=!1,f.disabled=!1})});m.addEventListener("click",()=>{l.reset(),w(),k(),m.disabled=!0});O.addEventListener("click",()=>{R(()=>l.step()),w(),m.disabled=!1});f.addEventListener("click",()=>{C?k():(C=!0,f.textContent="Stop",M()),m.disabled=!1});T.addEventListener("input",()=>{p=10**Number(T.value),v.textContent=$(p)});for(const s of W){const t=document.createElement("span"),e=document.createElement("span");t.textContent=0,e.append(`${s}: `,t," "),e.className="box",X.append(e),x.push(t)}for(let s=0;s<16;s++){const t=document.createElement("tr"),e=document.createElement("td");e.textContent=s*16,e.className="header",t.append(e);for(let i=0;i<16;i++){const r=document.createElement("td");r.className="mem",r.textContent=0,D.push(r),t.append(r)}Y.append(t)}m.disabled=!0;O.disabled=!0;f.disabled=!0;T.value=Math.log10(p);v.textContent=$(p);
